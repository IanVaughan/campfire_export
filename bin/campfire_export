#!/usr/bin/env ruby

lib = File.expand_path(File.join(File.dirname(__FILE__), '../lib'))
$LOAD_PATH.unshift(lib) if File.directory?(lib) && !$LOAD_PATH.include?(lib)

config_file = File.join(ENV['HOME'], '.campfire_export.yml')
config = CampfireExport::Config.new(config_file)

account = CampfireExport::Account.new(config.subdomain, config.api_token)

puts "=> Found rooms : " + account.rooms.map {|r| "'#{r.name}'" }.join(", ")

rooms = if config.included_rooms?
  account.rooms.keep_if do |room|
    config.included_rooms.any? do |included_room|
      included_room.upcase == room.name.upcase
    end
  end
elsif config.excluded_rooms?
  account.rooms.delete_if do |room|
    config.excluded_rooms.any? do |included_room|
      included_room.upcase == room.name.upcase
    end
  end
else
  account.rooms
end

puts "=> Using rooms : " + rooms.map {|r| "'#{r.name}'" }.join(", ")

rooms.each do |room|
  puts "=> Reading room : '#{room.name}'"
  room.export(config.start_date, config.end_date)
end
